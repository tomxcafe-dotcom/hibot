<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIBOT - Expert Advisor สำหรับ MT4/MT5</title>
    <style>
        /* ใช้ CSS เดิมทั้งหมด */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #1e2a3a;
            line-height: 1.6;
        }

        /* คัดลอก CSS ทั้งหมดจากโค้ดเดิม */
        .header {
            background: #fff;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* ... (เพิ่ม CSS ทั้งหมดจากโค้ดเดิม) ... */
    </style>
</head>
<body>
    <!-- HTML เดิมทั้งหมด -->
    
    <script>
        // *** ส่วนสำคัญ: เพิ่ม URL ของ Google Apps Script Web App ***
        const SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';

        let cart = [];
        let isTrialApproved = false;
        let isPurchaseApproved = false;

        // Trial Form Functions - ปรับปรุงให้ส่งข้อมูลไป Google Apps Script
        async function submitTrial(event) {
            event.preventDefault();
            
            const name = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const strategy = document.getElementById('strategy').value;
            const strategyText = document.getElementById('strategy').options[document.getElementById('strategy').selectedIndex].text;

            // ส่งข้อมูลไป Google Apps Script
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'trial',
                        name: name,
                        email: email,
                        phone: phone,
                        strategy: strategyText
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    // แสดงข้อมูลในโมดอล
                    document.getElementById('displayName').textContent = name;
                    document.getElementById('displayEmail').textContent = email;
                    document.getElementById('displayStrategy').textContent = strategyText;

                    // ซ่อนลิงก์ดาวน์โหลด
                    document.getElementById('downloadLinks').style.display = 'none';
                    isTrialApproved = false;

                    // เปิดโมดอล
                    document.getElementById('trialModal').style.display = 'block';

                    // รีเซ็ตฟอร์ม
                    document.getElementById('trialForm').reset();
                } else {
                    alert('เกิดข้อผิดพลาด: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ไม่สามารถส่งข้อมูลได้ กรุณาลองใหม่อีกครั้ง');
            }
        }

        function simulateAdminApproval() {
            isTrialApproved = true;
            document.querySelector('#trialModal .pending-message').style.display = 'none';
            document.getElementById('downloadLinks').style.display = 'block';
            alert('✓ Admin อนุมัติแล้ว! คุณสามารถดาวน์โหลด EA ได้แล้ว');
        }

        function closeTrialModal() {
            document.getElementById('trialModal').style.display = 'none';
        }

        // Cart Functions
        function addToCart(name, price) {
            cart.push({name, price});
            updateCartCount();
            alert('เพิ่ม ' + name + ' ลงตะกร้าแล้ว!');
        }

        function updateCartCount() {
            document.getElementById('cartCount').textContent = cart.length;
        }

        function openCart() {
            displayCart();
            document.getElementById('cartModal').style.display = 'block';
        }

        function closeCart() {
            document.getElementById('cartModal').style.display = 'none';
            resetCartModal();
        }

        function displayCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartTotalDiv = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<div class="empty-cart">ตะกร้าว่างเปล่า</div>';
                cartTotalDiv.innerHTML = '';
                document.getElementById('checkoutBtn').style.display = 'none';
                return;
            }

            document.getElementById('checkoutBtn').style.display = 'block';
            
            let html = '';
            let total = 0;

            cart.forEach((item, index) => {
                html += `
                    <div class="cart-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <span style="color: #20b89a;">฿${item.price.toLocaleString()}</span>
                        </div>
                        <button class="remove-btn" onclick="removeFromCart(${index})">ลบ</button>
                    </div>
                `;
                total += item.price;
            });

            cartItemsDiv.innerHTML = html;
            cartTotalDiv.innerHTML = `<strong>รวมทั้งหมด: ฿${total.toLocaleString()}</strong>`;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartCount();
            displayCart();
        }

        function showPayment() {
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('paymentAmount').textContent = '฿' + total.toLocaleString();
            document.getElementById('checkoutBtn').style.display = 'none';
            document.getElementById('paymentSection').style.display = 'block';
        }

        // ฟังก์ชันอัปโหลดสลิป
        function setupSlipUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const base64Data = event.target.result;
                        
                        // ขอ email จากผู้ใช้
                        const email = prompt('กรุณากรอกอีเมลของคุณ:');
                        if (!email) return;

                        try {
                            const response = await fetch(SCRIPT_URL, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    type: 'payment',
                                    email: email,
                                    slipBase64: base64Data,
                                    mimeType: file.type,
                                    fileName: file.name
                                })
                            });

                            const result = await response.json();
                            
                            if (result.status === 'success') {
                                alert('อัปโหลดสลิปสำเร็จ! รอการอนุมัติจาก Admin');
                                document.getElementById('paymentSection').style.display = 'none';
                                document.getElementById('downloadSection').style.display = 'block';
                            } else {
                                alert('เกิดข้อผิดพลาด: ' + result.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('ไม่สามารถอัปโหลดสลิปได้ กรุณาลองใหม่อีกครั้ง');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function confirmPayment() {
            if (confirm('คุณได้ทำการชำระเงินเรียบร้อยแล้วใช่หรือไม่?')) {
                setupSlipUpload();
            }
        }

        function simulatePurchaseApproval() {
            isPurchaseApproved = true;
            document.querySelector('#downloadSection .pending-message').style.display = 'none';
            document.querySelector('#downloadSection > p').style.display = 'none';
            document.getElementById('approvedDownload').style.display = 'block';
            alert('✓ Admin อนุมัติแล้ว! คุณสามารถดาวน์โหลด EA ได้แล้ว');
        }

        function resetCartModal() {
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('checkoutBtn').style.display = 'block';
            isPurchaseApproved = false;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const cartModal = document.getElementById('cartModal');
            const trialModal = document.getElementById('trialModal');
            
            if (event.target == cartModal) {
                closeCart();
            }
            if (event.target == trialModal) {
                closeTrialModal();
            }
        }
    </script>
</body>
</html>
